<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carte des Trottinettes à Marseille</title>
    <link href="../css/maps.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/baseCustom.css" />
    <script src="../js/script.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* #map {
            width: 1920px;
            height: 500px;
        } */
    </style>
</head>

<body>
    <header></header>
    <main>
        <h1>Trouvez une station levélo :</h1>
        <div id="searchStation">
            <h3>Votre recherche :</h3>

            <div>
                <label for="Recherche station"></label>
                <input id="findStation" type="text" placeholder="Rechercher une station" name="Rechercher une station">
            </div>
        </div>
        <div id="map"></div>

        <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
        <script>
            var map = L.map('map').setView([43.2965, 5.3698], 14);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; Contributeurs OpenStreetMap'
            }).addTo(map);

            var apiKey = "MjE0ZDNmMGEtNGFkZS00M2FlLWFmMWItZGNhOTZhMWQyYzM2";

            // Fonction pour obtenir les informations sur les stations
            function stationInformation() {
                return fetch("https://api.omega.fifteen.eu/gbfs/2.2/marseille/en/station_information.json?key=" + apiKey)
                    .then(response => response.json())
                    .then(data => data.data.stations);
            }

            // Fonction pour obtenir les status des stations (vélos disponibles)
            function stationStatus() {
                return fetch("https://api.omega.fifteen.eu/gbfs/2.2/marseille/en/station_status.json?key=" + apiKey)
                    .then(response => response.json())
                    .then(data => data.data.stations);
            }

            // Fonction pour obtenir l'icône de vélo en fonction du nombre de vélos disponibles
            function getBikeIcon(numBikesAvailable) {
                if (numBikesAvailable > 5) {
                    return L.icon({
                        iconUrl: '../img/assets/bike-green.svg',
                        iconSize: [32, 32],
                        iconAnchor: [16, 32],
                        popupAnchor: [0, -32]
                    });
                } else if (numBikesAvailable > 0) {
                    return L.icon({
                        iconUrl: '../img/assets/bike-orange.svg',
                        iconSize: [32, 32],
                        iconAnchor: [16, 32],
                        popupAnchor: [0, -32]
                    });
                } else {
                    return L.icon({
                        iconUrl: '../img/assets/bike-red.svg',
                        iconSize: [32, 32],
                        iconAnchor: [16, 32],
                        popupAnchor: [0, -32]
                    });
                }
            }

            // Fonction pour ajouter les marqueurs/ popup sur la carte avec les informations
            Promise.all([stationInformation(), stationStatus()])
                .then(([stationsInfo, stationsStatus]) => {
                    stationsInfo.forEach(stationInfo => {
                        var stationStatusInfo = stationsStatus.find(status => status.station_id === stationInfo.station_id);
                        console.log("========>", stationStatusInfo);
                        console.log(stationInfo); //données de la station ici
                        if (stationInfo.lat && stationInfo.lon && stationStatusInfo) {
                            var marker = L.marker([parseFloat(stationInfo.lat), parseFloat(stationInfo.lon)], {
                                icon: getBikeIcon(stationStatusInfo.num_bikes_available)
                            }).addTo(map);
                            marker.bindPopup('<b>Nom de la station:</b> ' + stationInfo.name + '<br><b>Vélos disponibles:</b> ' + stationStatusInfo.num_bikes_available);
                        }
                    });
                })
                .catch(error => console.error('Erreur lors de la récupération des données:', error));

        </script>
        <div id="button-container">
            <button id="button-green">Top</button>
        </div>


    </main>
    <script>
        displayHeader();
        displayFooter();
        burgerMenu();
    </script>
</body>

</html>